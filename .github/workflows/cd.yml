name: Continuous Delivery (CD)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    # ğŸ’¡ CIã‚¸ãƒ§ãƒ– (ci) ãŒæˆåŠŸã—ãŸå ´åˆã«ã®ã¿å®Ÿè¡Œ
    needs: ci
    runs-on: ubuntu-latest
    
    # Cloudflareã®èªè¨¼æƒ…å ±ã‚’è¨­å®š
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      # ğŸ’¡ D1ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®è‡ªå‹•é©ç”¨ã‚¹ãƒ†ãƒƒãƒ—
      # --remoteãƒ•ãƒ©ã‚°ã‚’ä»˜ã‘ã€æœ¬ç•ªDBã«æœªé©ç”¨ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã—ã¾ã™
      - name: ğŸ”„ Apply D1 Migrations to Remote DB
        # todo_DB ã¯ wrangler.toml ã® binding å
        run: npx wrangler d1 migrations apply todo_DB --remote

      - name: ğŸš€ Deploy Worker to Cloudflare
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ env.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          # ğŸ’¡ --name ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ wrangler.toml ã® name ãŒä½¿ã‚ã‚Œã‚‹ãŸã‚çœç•¥ã—ã¦ã‚‚OKã§ã™